# お弁当メニュー機能 - アーキテクチャ設計

## 概要
TheMealDB + USDA FoodData Central を活用した完全無料のお弁当メニュー生成システム

## API連携戦略

### 1. TheMealDB API
**料金**: 完全無料（制限あり）
**レート制限**: 実質なし（開発用）
**取得データ**:
- レシピ詳細（材料・分量・調理手順）
- カテゴリ（Seafood, Chicken, Vegetarian等）
- 地域別（Japanese, Italian, Chinese等）
- 材料画像・レシピ画像

**主要エンドポイント**:
```
GET /api/json/v1/1/random.php              # ランダムレシピ
GET /api/json/v1/1/filter.php?c=Seafood    # カテゴリフィルタ
GET /api/json/v1/1/filter.php?a=Japanese   # 地域フィルタ
GET /api/json/v1/1/search.php?s=chicken    # レシピ検索
```

### 2. USDA FoodData Central API
**料金**: 完全無料
**レート制限**: 1,000 requests/hour/IP
**取得データ**:
- 栄養成分（カロリー、タンパク質、炭水化物、脂質、ビタミン、ミネラル）
- 食材重量あたりの栄養価
- 複数データベース（SR Legacy, FNDDS, Branded Foods）

**主要エンドポイント**:
```
GET /fdc/v1/foods/search?query=chicken+breast  # 食材検索
POST /fdc/v1/foods                             # 複数食材一括取得
GET /fdc/v1/food/{fdcId}                       # 詳細栄養情報
```

## 実装アプローチ

### フェーズ1: MVP（最小機能）
1. **レシピ取得**: TheMealDBから基本レシピ
2. **材料マッピング**: 簡単な辞書でTheMealDB → USDA変換
3. **栄養計算**: 基本的なカロリー・三大栄養素のみ
4. **お弁当サイズ**: 固定サイズでの計算

### フェーズ2: 精度向上
1. **材料辞書拡充**: より正確なマッピング
2. **密度表追加**: 体積→重量変換の精度向上
3. **複数レシピ組み合わせ**: バランスの取れたお弁当
4. **栄養目標設定**: ユーザー別の栄養要求

### フェーズ3: 高度化
1. **機械学習**: マッピング精度自動改善
2. **季節性考慮**: 旬の食材優先
3. **コスト最適化**: 価格データ連携
4. **アレルギー対応**: より詳細な制約

## データフロー

```
1. ユーザーがお弁当サイズ・好み選択
   ↓
2. TheMealDB APIでレシピ候補取得
   ↓ 
3. レシピ材料をUSDA食材IDにマッピング
   ↓
4. USDA APIで各材料の栄養データ取得
   ↓
5. 分量調整＆栄養計算（合計・1食あたり）
   ↓
6. お弁当メニュー＆栄養表示提示
```

## 技術的課題と解決策

### 課題1: 材料マッピングの精度
**問題**: TheMealDB "chicken breast" → USDA "Chicken, broilers or fryers, breast, meat only, raw"
**解決策**: 
- 段階的辞書構築
- Fuzzy matching アルゴリズム
- ユーザーフィードバック学習

### 課題2: 分量単位の統一
**問題**: TheMealDB "1 cup" → USDA "100g"
**解決策**:
- 密度変換表の構築
- 標準的な計量カップ・スプーン換算表
- 材料別の密度データベース

### 課題3: レート制限対策
**問題**: USDA API 1,000 req/hour制限
**解決策**:
- 積極的キャッシング戦略
- バッチ処理での効率化
- Redis等での結果保存

### 課題4: 日本のお弁当との差
**問題**: TheMealDBは主に西洋料理中心
**解決策**:
- 日本料理フィルタリング優先
- 独自レシピデータベース補完
- ユーザー投稿レシピ機能

## 実装ロードマップ

### Week 1-2: 基盤構築
- [ ] TheMealDB API連携実装
- [ ] USDA API連携実装  
- [ ] 基本的な材料マッピング辞書作成
- [ ] シンプルな栄養計算ロジック

### Week 3-4: UI/UX開発
- [ ] レシピ検索画面
- [ ] お弁当メニュー表示画面
- [ ] 栄養情報ダッシュボード
- [ ] ユーザー設定画面

### Week 5-6: 精度向上
- [ ] 材料マッピング辞書拡充
- [ ] 密度変換表実装
- [ ] キャッシング戦略実装
- [ ] エラーハンドリング強化

## コスト分析

### 完全無料での運用
✅ **API料金**: $0 (両API無料)
✅ **基本機能**: 完全実装可能
✅ **MVP展開**: 制限なし

### スケール時の考慮事項
- TheMealDB: プレミアム版($5/月)で複数材料フィルタ
- USDA: レート制限超過時の対応策
- インフラ: サーバー・データベース・キャッシュ

## 成功可能性評価

### 🟢 高い成功要因
1. **両API安定稼働**: 政府・公的機関提供で信頼性高
2. **豊富なデータ**: 数万レシピ＋数十万食材栄養データ
3. **完全無料**: 初期投資ゼロでMVP構築可能
4. **段階的改善**: 精度は後から向上可能

### 🟡 注意すべきリスク  
1. **材料マッピング精度**: 初期は70-80%程度の精度予想
2. **日本料理の少なさ**: TheMealDBの地域偏り
3. **レート制限**: 大規模利用時の制約

### 結論
**🚀 実装推奨！** 
完全無料でMVP構築可能で、段階的な改善により実用レベルまで引き上げ可能。初期投資リスクがないため、試行錯誤しながら最適化していける理想的なアプローチです。