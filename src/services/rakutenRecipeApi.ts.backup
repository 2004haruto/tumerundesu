// src/services/rakutenRecipeApi.ts
// 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI + schema.org謚ｽ蜃ｺ縺ｫ繧医ｋ譌･譛ｬ隱槭Ξ繧ｷ繝泌叙蠕励し繝ｼ繝薙せ

// 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI險ｭ螳・
const RAKUTEN_APP_ID = process.env.EXPO_PUBLIC_RAKUTEN_APP_ID || 'YOUR_RAKUTEN_APP_ID';
const RAKUTEN_BASE_URL = 'https://app.rakuten.co.jp/services/api/Recipe';

// 繝ｬ繝ｼ繝亥宛蠕｡險ｭ螳・
const RATE_LIMIT_DELAY = 1500; // 1.5遘帝俣髫・(429繧ｨ繝ｩ繝ｼ蟇ｾ遲・
const MAX_CACHE_SIZE = 100; // 繧ｭ繝｣繝・・ｽ・ｽ繝･譛螟ｧ繧ｵ繧､繧ｺ
const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24譎る俣

// 蝙句ｮ夂ｾｩ
export interface RakutenRecipeBasic {
  recipeId: string;
  recipeTitle: string;
  recipeUrl: string;
  foodImageUrl: string;
  recipeMaterial: string[];
  recipeDescription?: string;
  recipeCost?: string;
  recipeIndication?: string; // 隱ｿ逅・・ｽ・ｽ髢・
  categoryId?: string;
}

export interface SchemaOrgRecipe {
  name: string;
  description?: string;
  image?: string;
  video?: string;  // 繝｡繧､繝ｳ繝ｬ繧ｷ繝泌虚逕ｻ
  recipeIngredient: string[];
  recipeInstructions: RecipeInstruction[];
  totalTime?: string;
  prepTime?: string;
  cookTime?: string;
  recipeYield?: string;
  nutrition?: {
    calories?: string;
  };
}

export interface RecipeInstruction {
  text: string;
  name?: string;
  url?: string;
  image?: string;
  video?: string;  // 蜍慕判URL・ｽE・ｽEp4, webm, YouTube蝓九ａ霎ｼ縺ｿURL遲会ｼ・
  images?: string[];  // 隍・・ｽ・ｽ縺ｮ逕ｻ蜒酋RL・ｽE・ｽ謇矩・・ｽE隧ｳ邏ｰ逕ｻ蜒擾ｼ・
}

export interface ProcessedJapaneseRecipe {
  id: string;
  title: string;
  description: string;
  imageUrl: string;
  sourceUrl: string;
  ingredients: {
    name: string;
    amount: string;
  }[];
  instructions: {
    stepNumber: number;
    text: string;
    image?: string;
    video?: string;  // 謇矩・・ｽ・ｽ逕ｻ
    images?: string[];  // 隍・・ｽ・ｽ縺ｮ謇矩・・ｽ・ｽ蜒・
  }[];
  cookingTime?: string;
  servings?: string;
  difficulty?: string;
  cost?: string;
  nutrition?: {
    calories?: string;
  };
  source: 'rakuten';
  createdAt: number;
}

// 繧ｭ繝｣繝・・ｽ・ｽ繝･邂｡逅・
class RecipeCache {
  private cache = new Map<string, { data: any; timestamp: number }>();

  set(key: string, data: any): void {
    // 繧ｭ繝｣繝・・ｽ・ｽ繝･繧ｵ繧､繧ｺ蛻ｶ髯・
    if (this.cache.size >= MAX_CACHE_SIZE) {
      const oldestKey = this.cache.keys().next().value;
      this.cache.delete(oldestKey);
    }
    
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }

  get(key: string): any | null {
    const item = this.cache.get(key);
    if (!item) return null;

    // 譛滄剞蛻・・ｽ・ｽ繝√ぉ繝・・ｽ・ｽ
    if (Date.now() - item.timestamp > CACHE_EXPIRY) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  clear(): void {
    this.cache.clear();
  }
}

// 繝ｬ繝ｼ繝亥宛蠕｡
class RateLimiter {
  private lastRequestTime = 0;

  async waitIfNeeded(): Promise<void> {
    const now = Date.now();
    const timeSinceLastRequest = now - this.lastRequestTime;
    
    if (timeSinceLastRequest < RATE_LIMIT_DELAY) {
      const waitTime = RATE_LIMIT_DELAY - timeSinceLastRequest;
      await new Promise(resolve => setTimeout(resolve, waitTime));
    }
    
    this.lastRequestTime = Date.now();
  }
}

export class RakutenRecipeApiService {
  private cache = new RecipeCache();
  private rateLimiter = new RateLimiter();

  /**
   * 剥 繝・・ｽ・ｽ繝・・ｽ・ｽ逕ｨ: 繧ｫ繝・・ｽ・ｽ繝ｪ1-50繧呈爾邏｢縺励※繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ蜷ｫ繧繧ｫ繝・・ｽ・ｽ繝ｪ繧堤音螳・
   */
  async debugCategoryExploration(keyword: string = '縺阪ｅ縺・・ｽ・ｽ'): Promise<void> {
    console.log(`\n剥 ========== 繧ｫ繝・・ｽ・ｽ繝ｪ謗｢邏｢髢句ｧ・==========`);
    console.log(`識 讀懃ｴ｢繧ｭ繝ｼ繝ｯ繝ｼ繝・ "${keyword}"`);
    console.log(`答 繧ｫ繝・・ｽ・ｽ繝ｪ1-50繧定ｪｿ譟ｻ荳ｭ...`);
    console.log(`=====================================\n`);
    
    const keywords = this.generateKeywordVariations(keyword);
    const foundCategories: { categoryId: number; matchCount: number; sampleTitle: string }[] = [];

    for (let categoryId = 1; categoryId <= 50; categoryId++) {
      try {
        const recipes = await this.getRecipesByCategory(categoryId.toString());
        
        if (recipes.length > 0) {
          // 縺難ｿｽE繧ｫ繝・・ｽ・ｽ繝ｪ縺ｧ繧ｭ繝ｼ繝ｯ繝ｼ繝峨↓荳閾ｴ縺吶ｋ繝ｬ繧ｷ繝斐ｒ讀懃ｴ｢
          const matches = recipes.filter(recipe => {
            const searchText = `${recipe.recipeTitle} ${recipe.recipeMaterial?.join(' ')} ${recipe.recipeDescription || ''}`.toLowerCase();
            return keywords.some(kw => searchText.includes(kw.toLowerCase()));
          });

          if (matches.length > 0) {
            foundCategories.push({
              categoryId,
              matchCount: matches.length,
              sampleTitle: matches[0].recipeTitle
            });
            console.log(`笨・繧ｫ繝・・ｽ・ｽ繝ｪ${categoryId}: 識${matches.length}莉ｶ繝偵ャ繝・- 萓・ "${matches[0].recipeTitle}"`);
          } else {
            console.log(`唐 繧ｫ繝・・ｽ・ｽ繝ｪ${categoryId}: ${recipes.length}莉ｶ - "${recipes[0].recipeTitle.substring(0, 30)}..."`);
          }
        } else {
          console.log(`笶・繧ｫ繝・・ｽ・ｽ繝ｪ${categoryId}: 繝ｬ繧ｷ繝斐↑縺輿);
        }
        
        // 繝ｬ繝ｼ繝亥宛髯仙ｯｾ遲・ 3遘貞ｾ・・ｽ・ｽE
        await new Promise(resolve => setTimeout(resolve, 3000));
        
      } catch (error: any) {
        console.warn(`笞・ｽE・ｽE繧ｫ繝・・ｽ・ｽ繝ｪ${categoryId}蜿門ｾ怜､ｱ謨・`, error?.message);
        
        // 429繧ｨ繝ｩ繝ｼ縺ｮ蝣ｴ蜷茨ｿｽE霑ｽ蜉縺ｧ蠕・・ｽ・ｽE
        if (error?.message?.includes('429')) {
          console.log(`竢ｸ・ｽE・ｽE繝ｬ繝ｼ繝亥宛髯先､懶ｿｽE縲・遘貞ｾ・・ｽ・ｽE..`);
          await new Promise(resolve => setTimeout(resolve, 5000));
        } else {
          // 縺晢ｿｽE莉厄ｿｽE繧ｨ繝ｩ繝ｼ縺ｯ2遘貞ｾ・・ｽ・ｽE
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }
    }

    console.log(`\n========== 識 讀懃ｴ｢邨先棡繧ｵ繝槭Μ ==========`);
    if (foundCategories.length > 0) {
      console.log(`笨・"${keyword}" 繧貞性繧繧ｫ繝・・ｽ・ｽ繝ｪ: ${foundCategories.length}蛟狗匱隕欺n`);
      foundCategories.forEach(cat => {
        console.log(`  刀 繧ｫ繝・・ｽ・ｽ繝ｪ${cat.categoryId}: ${cat.matchCount}莉ｶ`);
        console.log(`     萓・ "${cat.sampleTitle}"`);
      });
      console.log(`\n庁 縺翫☆縺吶ａ繧ｫ繝・・ｽ・ｽ繝ｪ: [${foundCategories.map(c => c.categoryId).join(', ')}]`);
    } else {
      console.log(`笶・"${keyword}" 繧貞性繧繧ｫ繝・・ｽ・ｽ繝ｪ縺ｯ隕九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆`);
      console.log(`庁 API縺ｮ繧ｫ繝・・ｽ・ｽ繝ｪ縺ｫ隧ｲ蠖薙Ξ繧ｷ繝斐′蜷ｫ縺ｾ繧後※縺・・ｽ・ｽ縺・・ｽ・ｽ閭ｽ諤ｧ縺後≠繧翫∪縺兪);
    }
    console.log(`=====================================\n`);
  }

  // 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI: 繧ｭ繝ｼ繝ｯ繝ｼ繝画､懃ｴ｢ (隍・・ｽ・ｽ繧ｫ繝・・ｽ・ｽ繝ｪ縺九ｉ蜿門ｾ励＠縺ｦ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ)
  async searchRecipesByKeyword(keyword: string, categoryId?: string): Promise<RakutenRecipeBasic[]> {
    await this.rateLimiter.waitIfNeeded();

    try {
      // 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI縺ｯkeyword繝代Λ繝｡繝ｼ繧ｿ髱槫ｯｾ蠢懶ｿｽE縺溘ａ縲・
      // 髢｢騾｣繧ｫ繝・・ｽ・ｽ繝ｪ縺九ｉ螟壹ａ縺ｫ蜿門ｾ励＠縺ｦ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
      const categories = categoryId ? [categoryId] : this.getRelevantCategoriesForKeyword(keyword);
      const allRecipes: RakutenRecipeBasic[] = [];
      
      console.log(`剥 讌ｽ螟ｩAPI 繧ｫ繝・・ｽ・ｽ繝ｪ讀懃ｴ｢: "${keyword}" (繧ｫ繝・・ｽ・ｽ繝ｪ: ${categories.join(', ')})`);
      
      for (const catId of categories.slice(0, 3)) { // 譛螟ｧ3繧ｫ繝・・ｽ・ｽ繝ｪ (蟷・・ｽ・ｽE・ｽ・ｽ讀懃ｴ｢)
        const url = `${RAKUTEN_BASE_URL}/CategoryRanking/20170426?` +
          `applicationId=${RAKUTEN_APP_ID}&` +
          `categoryId=${catId}&` +
          `format=json`;
        
        const response = await fetch(url);
        if (!response.ok) {
          console.warn(`笞・ｽE・ｽE繧ｫ繝・・ｽ・ｽ繝ｪ ${catId} 蜿門ｾ怜､ｱ謨・ ${response.status}`);
          
          // 429繧ｨ繝ｩ繝ｼ縺ｮ蝣ｴ蜷茨ｿｽE蠕・・ｽ・ｽ譎る俣繧貞ｻｶ髟ｷ
          if (response.status === 429) {
            console.log(`竢ｸ・ｽE・ｽE繝ｬ繝ｼ繝亥宛髯先､懶ｿｽE縲・遘貞ｾ・・ｽ・ｽE..`);
            await new Promise(resolve => setTimeout(resolve, 3000));
          }
          continue;
        }

        const data = await response.json();
        const recipes: RakutenRecipeBasic[] = data.result?.map((item: any) => ({
          recipeId: item.recipeId,
          recipeTitle: item.recipeTitle,
          recipeUrl: item.recipeUrl,
          foodImageUrl: item.foodImageUrl,
          recipeMaterial: item.recipeMaterial || [],
          recipeDescription: item.recipeDescription,
          recipeCost: item.recipeCost,
          recipeIndication: item.recipeIndication,
          categoryId: item.categoryId
        })) || [];
        
        allRecipes.push(...recipes);
        console.log(`笨・繧ｫ繝・・ｽ・ｽ繝ｪ ${catId}: ${recipes.length}莉ｶ蜿門ｾ輿);
        
        // 繝・・ｽ・ｽ繝・・ｽ・ｽ: 蜿門ｾ励＠縺溘Ξ繧ｷ繝費ｿｽE繧ｿ繧､繝医Ν繧抵ｿｽE縺ｦ陦ｨ遉ｺ
        if (recipes.length > 0) {
          console.log(`搭 繧ｫ繝・・ｽ・ｽ繝ｪ ${catId} 縺ｮ繝ｬ繧ｷ繝比ｸ隕ｧ:`);
          recipes.forEach((recipe, idx) => {
            console.log(`   ${idx + 1}. "${recipe.recipeTitle}"`);
          });
        }
        
        // 繝ｬ繝ｼ繝亥宛髯仙ｯｾ遲・ 2遘貞ｾ・・ｽ・ｽE
        if (categories.length > 1 && catId !== categories[categories.length - 1]) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      }

      // 繧ｭ繝ｼ繝ｯ繝ｼ繝峨ヰ繝ｪ繧ｨ繝ｼ繧ｷ繝ｧ繝ｳ繧堤函謌・
      const keywordVariations = this.generateKeywordVariations(keyword);
      console.log(`剥 讀懃ｴ｢繝舌Μ繧ｨ繝ｼ繧ｷ繝ｧ繝ｳ: [${keywordVariations.join(', ')}]`);
      
      // 繧ｯ繝ｩ繧､繧｢繝ｳ繝茨ｿｽE縺ｧ繧ｭ繝ｼ繝ｯ繝ｼ繝峨ヵ繧｣繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
      const filtered = allRecipes.filter(recipe => {
        // 繧ｿ繧､繝医Ν繝√ぉ繝・・ｽ・ｽ
        const titleMatch = keywordVariations.some(kw => 
          recipe.recipeTitle?.toLowerCase().includes(kw.toLowerCase())
        );
        
        // 譚先侭繝√ぉ繝・・ｽ・ｽ
        const materialMatch = recipe.recipeMaterial?.some((mat: string) => 
          keywordVariations.some(kw => mat.toLowerCase().includes(kw.toLowerCase()))
        );
        
        // 隱ｬ譏弱メ繧ｧ繝・・ｽ・ｽ
        const descMatch = keywordVariations.some(kw => 
          recipe.recipeDescription?.toLowerCase().includes(kw.toLowerCase())
        );
        
        return titleMatch || materialMatch || descMatch;
      });

      console.log(`笨・"${keyword}" 縺ｧ ${filtered.length}/${allRecipes.length}莉ｶ縺ｮ繝ｬ繧ｷ繝斐ｒ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ`);
      
      return filtered;
    } catch (error) {
      console.warn(`笶・繧ｭ繝ｼ繝ｯ繝ｼ繝画､懃ｴ｢繧ｨ繝ｩ繝ｼ ("${keyword}"):`, error);
      return [];
    }
  }

  // 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI: 繧ｫ繝・・ｽ・ｽ繝ｪ蛻･繝ｬ繧ｷ繝泌叙蠕・
  async getRecipesByCategory(categoryId: string = '30', page: number = 1): Promise<RakutenRecipeBasic[]> {
    const cacheKey = `category_${categoryId}_${page}`;
    const cached = this.cache.get(cacheKey);
    if (cached) {
      console.log('識 繧ｭ繝｣繝・・ｽ・ｽ繝･縺九ｉ繝ｬ繧ｷ繝斐ｒ蜿門ｾ・', categoryId);
      return cached;
    }

    await this.rateLimiter.waitIfNeeded();

    try {
      const url = `${RAKUTEN_BASE_URL}/CategoryRanking/20170426?` +
        `applicationId=${RAKUTEN_APP_ID}&` +
        `categoryId=${categoryId}&` +
        `page=${page}&` +
        `format=json`;

      console.log('些 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI蜻ｼ縺ｳ蜃ｺ縺・', { categoryId, page });
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`讌ｽ螟ｩAPI 繧ｨ繝ｩ繝ｼ: ${response.status}`);
      }

      const data = await response.json();
      const recipes: RakutenRecipeBasic[] = data.result?.map((item: any) => ({
        recipeId: item.recipeId,
        recipeTitle: item.recipeTitle,
        recipeUrl: item.recipeUrl,
        foodImageUrl: item.foodImageUrl,
        recipeMaterial: item.recipeMaterial || [],
        recipeDescription: item.recipeDescription,
        recipeCost: item.recipeCost,
        recipeIndication: item.recipeIndication,
        categoryId: item.categoryId
      })) || [];

      this.cache.set(cacheKey, recipes);
      console.log(`笨・${recipes.length}莉ｶ縺ｮ繝ｬ繧ｷ繝斐ｒ蜿門ｾ輿);
      
      return recipes;
    } catch (error) {
      console.warn('笶・讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI 繧ｨ繝ｩ繝ｼ:', error);
      return [];
    }
  }

  // 繝ｬ繧ｷ繝費ｿｽE繝ｼ繧ｸ縺九ｉschema.org/Recipe謚ｽ蜃ｺ
  async extractSchemaFromRecipeUrl(url: string): Promise<SchemaOrgRecipe | null> {
    const cacheKey = `schema_${url}`;
    const cached = this.cache.get(cacheKey);
    if (cached) {
      return cached;
    }

    await this.rateLimiter.waitIfNeeded();

    try {
      console.log('剥 schema.org謚ｽ蜃ｺ髢句ｧ・', url);
      
      // CORS蝗樣∩縺ｮ縺溘ａ縲・ｿｽE繝ｭ繧ｭ繧ｷ縺悟ｿ・・ｽ・ｽ縺ｪ蝣ｴ蜷医′縺ゅｊ縺ｾ縺・
      // 譛ｬ逡ｪ迺ｰ蠅・・ｽ・ｽ縺ｯ驕ｩ蛻・・ｽ・ｽ繝励Ο繧ｭ繧ｷ繧ｵ繝ｼ繝撰ｿｽE繧剃ｽｿ逕ｨ縺励※縺上□縺輔＞
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`繝ｬ繧ｷ繝費ｿｽE繝ｼ繧ｸ蜿門ｾ励お繝ｩ繝ｼ: ${response.status}`);
      }

      const html = await response.text();
      
      // 蜍慕判URL謚ｽ蜃ｺ・ｽE・ｽ隍・・ｽ・ｽ繝代ち繝ｼ繝ｳ蟇ｾ蠢懶ｿｽE蜴ｳ譬ｼ縺ｪ讀懆ｨｼ・ｽE・ｽE
      const extractVideoUrls = (html: string): string[] => {
        const videoUrls: string[] = [];
        
        // YouTube蝓九ａ霎ｼ縺ｿ縺ｮ隧ｳ邏ｰ讀懶ｿｽE
        const youtubePatterns = [
          /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/g,
          /youtu\.be\/([a-zA-Z0-9_-]{11})/g,
          /youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/g
        ];
        
        youtubePatterns.forEach(pattern => {
          let match;
          while ((match = pattern.exec(html)) !== null) {
            const videoId = match[1];
            if (videoId && videoId.length === 11) { // YouTube縺ｮ繝薙ョ繧ｪID縺ｯ11譁・・ｽ・ｽE
              videoUrls.push(`https://www.youtube.com/watch?v=${videoId}`);
            }
          }
        });
        
        // video隕∫ｴ縺ｮsrc・ｽE・ｽ繧医ｊ蜴ｳ蟇・・ｽ・ｽE
        const videoElementMatches = html.match(/<video[^>]+>/g);
        if (videoElementMatches) {
          videoElementMatches.forEach(videoTag => {
            const srcMatch = videoTag.match(/src=["']([^"']+)["']/);
            if (srcMatch && srcMatch[1]) {
              const src = srcMatch[1];
              // 蜍慕判繝輔ぃ繧､繝ｫ蠖｢蠑擾ｿｽE縺ｿ繧定ｨｱ蜿ｯ
              if (/\.(mp4|webm|ogg|avi|mov|wmv|flv|mkv|m4v)(\?.*)?$/i.test(src)) {
                videoUrls.push(src);
              }
            }
          });
        }
        
        // 縺晢ｿｽE莉厄ｿｽE蜍慕判繝励Λ繝・・ｽ・ｽ繝輔か繝ｼ繝
        const vimeoMatches = html.match(/vimeo\.com\/(\d+)/g);
        if (vimeoMatches) {
          videoUrls.push(...vimeoMatches);
        }
        
        // 逶ｴ謗･逧・・ｽ・ｽ蜍慕判繝輔ぃ繧､繝ｫ繝ｪ繝ｳ繧ｯ・ｽE・ｽ繧ｳ繝ｳ繝・・ｽ・ｽ繧ｹ繝医′隱ｿ逅・・ｽ・ｽ髢｢騾｣縺吶ｋ蝣ｴ蜷茨ｿｽE縺ｿ・ｽE・ｽE
        const directVideoMatches = html.match(/https?:\/\/[^\s"'<>]+\.(mp4|webm|ogg|avi|mov|wmv|flv|mkv|m4v)(\?[^\s"'<>]*)?/g);
        if (directVideoMatches) {
          const cookingRelatedVideos = directVideoMatches.filter(url => {
            const cookingKeywords = ['cook', 'recipe', 'step', 'making', 'tutorial', 'how-to'];
            return cookingKeywords.some(keyword => 
              url.toLowerCase().includes(keyword) || 
              html.toLowerCase().includes(`${keyword}`) // 蜻ｨ霎ｺ繝・・ｽ・ｽ繧ｹ繝医ｂ繝√ぉ繝・・ｽ・ｽ
            );
          });
          videoUrls.push(...cookingRelatedVideos);
        }
        
        return [...new Set(videoUrls)].slice(0, 2); // 譛螟ｧ2蛟九↓蛻ｶ髯・
      };

      // JSON-LD蠖｢蠑擾ｿｽEschema.org謚ｽ蜃ｺ
      const jsonLdMatch = html.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);
      
      if (jsonLdMatch) {
        for (const match of jsonLdMatch) {
          try {
            const jsonContent = match.replace(/<script[^>]*>/, '').replace(/<\/script>/, '');
            const schema = JSON.parse(jsonContent);
            
            // Recipe蝙具ｿｽEschema繧呈爾縺・
            const recipe = Array.isArray(schema) 
              ? schema.find(item => item['@type'] === 'Recipe')
              : schema['@type'] === 'Recipe' ? schema : null;

            if (recipe) {
              // HTML縺九ｉ霑ｽ蜉縺ｮ蜍慕判URL繧呈歓蜃ｺ
              const detectedVideos = extractVideoUrls(html);
              const mainVideo = this.extractVideoUrl(recipe.video || recipe['@graph']?.video) || detectedVideos[0];
              
              const processedRecipe: SchemaOrgRecipe = {
                name: recipe.name,
                description: recipe.description,
                image: this.extractBestImage(recipe.image),
                video: mainVideo,
                recipeIngredient: Array.isArray(recipe.recipeIngredient) ? recipe.recipeIngredient : [],
                recipeInstructions: this.processInstructions(recipe.recipeInstructions, html),
                totalTime: recipe.totalTime,
                prepTime: recipe.prepTime,
                cookTime: recipe.cookTime,
                recipeYield: recipe.recipeYield,
                nutrition: recipe.nutrition
              };
              
              console.log('道 繝｡繝・・ｽ・ｽ繧｢繧ｳ繝ｳ繝・・ｽ・ｽ繝・・ｽ・ｽ・ｽE邨先棡:', {
                recipeName: recipe.name,
                mainVideo,
                detectedVideosCount: detectedVideos.length,
                detectedVideos: detectedVideos,
                mainImage: this.extractBestImage(recipe.image),
                instructionsWithMedia: recipe.recipeInstructions?.filter(inst => 
                  inst.image || inst.video || inst.images
                ).length || 0
              });

              this.cache.set(cacheKey, processedRecipe);
              console.log('笨・schema.org謚ｽ蜃ｺ螳御ｺ・', recipe.name);
              return processedRecipe;
            }
          } catch (parseError) {
            console.warn('笞・ｽE・ｽEJSON-LD隗｣譫舌お繝ｩ繝ｼ:', parseError);
          }
        }
      }

      // Microdata蠖｢蠑擾ｿｽE謚ｽ蜃ｺ・ｽE・ｽ繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・ｽE・ｽE
      const microdataRecipe = this.extractMicrodata(html);
      if (microdataRecipe) {
        this.cache.set(cacheKey, microdataRecipe);
        return microdataRecipe;
      }

      console.warn('笞・ｽE・ｽEschema.org縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ:', url);
      return null;
    } catch (error) {
      console.warn('笶・schema.org謚ｽ蜃ｺ繧ｨ繝ｩ繝ｼ:', error);
      return null;
    }
  }

  // 隱ｿ逅・・ｽ・ｽ鬆・・ｽE蜃ｦ逅・
  private processInstructions(instructions: any, html?: string): RecipeInstruction[] {
    if (!instructions) return [];
    
    if (Array.isArray(instructions)) {
      return instructions.map((inst, index) => {
        let stepSpecificImages: string[] = [];
        
        // HTML縺九ｉ謇矩・・ｽ・ｽ譛会ｿｽE逕ｻ蜒上ｒ讀懃ｴ｢・ｽE・ｽ謇矩・・ｽ・ｽ蜿ｷ繧・・ｽ・ｽ繝ｼ繝ｯ繝ｼ繝峨〒邨槭ｊ霎ｼ縺ｿ・ｽE・ｽE
        if (html && inst.text) {
          const stepNumber = index + 1;
          const stepKeywords = inst.text.split(/[縲ゅ―s]+/).filter(word => word.length > 1).slice(0, 2);
          stepSpecificImages = this.extractStepSpecificImages(html, stepNumber, stepKeywords);
        }
        
        // 謇矩・・ｽ・ｽ譛会ｿｽE逕ｻ蜒擾ｿｽE縺ｿ繧剃ｽｿ逕ｨ・ｽE・ｽ・ｽE謇矩・・ｽE騾夲ｿｽE逕ｻ蜒擾ｿｽE髯､螟厄ｼ・
        const instructionImage = inst.image ? this.extractBestImage(inst.image) : undefined;
        const instructionImages = stepSpecificImages.length > 0 
          ? stepSpecificImages 
          : (instructionImage ? [instructionImage] : []);
        
        return {
          text: typeof inst === 'string' ? inst : inst.text || inst.name || '',
          name: inst.name,
          url: inst.url,
          image: instructionImages[0], // 譛蛻晢ｿｽE逕ｻ蜒上ｒ繝｡繧､繝ｳ逕ｻ蜒上↓
          video: this.extractVideoUrl(inst.video),
          images: instructionImages.slice(1) // 谿九ｊ繧定ｿｽ蜉逕ｻ蜒上↓
        };
      });
    }
    
    if (typeof instructions === 'string') {
      return [{ text: instructions }];
    }
    
    return [{ 
      text: instructions.text || instructions.name || '',
      image: this.extractBestImage(instructions.image),
      video: this.extractVideoUrl(instructions.video),
      images: this.extractMultipleImages(instructions.images || instructions.image)
    }];
  }

  // 譛驕ｩ縺ｪ逕ｻ蜒酋RL繧呈歓蜃ｺ・ｽE・ｽ蜩∬ｳｪ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ莉倥″・ｽE・ｽE
  private extractBestImage(imageData: any): string | undefined {
    if (!imageData) return undefined;
    
    const validateImageUrl = (url: string): boolean => {
      if (!url || typeof url !== 'string') return false;
      
      // 蝓ｺ譛ｬ逧・・ｽ・ｽURL蠖｢蠑上メ繧ｧ繝・・ｽ・ｽ
      if (!url.startsWith('http')) return false;
      
      // 逕ｻ蜒乗僑蠑ｵ蟄舌メ繧ｧ繝・・ｽ・ｽ
      const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)(\?.*)?$/i;
      if (!imageExtensions.test(url)) return false;
      
      // 髯､螟悶＠縺溘＞逕ｻ蜒上ヱ繧ｿ繝ｼ繝ｳ・ｽE・ｽ繧医ｊ蜴ｳ譬ｼ・ｽE・ｽE
      const excludePatterns = [
        /logo/i,           // 繝ｭ繧ｴ逕ｻ蜒・
        /banner/i,         // 繝舌リ繝ｼ逕ｻ蜒・
        /ad[s]?/i,        // 蠎・・ｽ・ｽ逕ｻ蜒・
        /avatar/i,         // 繧｢繝舌ち繝ｼ逕ｻ蜒・
        /profile/i,        // 繝励Ο繝輔ぅ繝ｼ繝ｫ逕ｻ蜒・
        /icon/i,           // 繧｢繧､繧ｳ繝ｳ逕ｻ蜒・
        /thumbnail/i,      // 繧ｵ繝繝阪う繝ｫ・ｽE・ｽ蟆上＆縺吶℃繧句庄閭ｽ諤ｧ・ｽE・ｽE
        /thumb/i,          // 繧ｵ繝繝阪う繝ｫ・ｽE・ｽ逡･遘ｰ・ｽE・ｽE
        /button/i,         // 繝懊ち繝ｳ逕ｻ蜒・
        /decoration/i,     // 陬・・ｽ・ｽ逕ｻ蜒・
        /background/i,     // 閭梧勹逕ｻ蜒・
        /\d{1,2}x\d{1,2}/i,// 蟆上＆縺・・ｽ・ｽ繧､繧ｺ・ｽE・ｽ萓具ｼ・0x50・ｽE・ｽE
        /blank/i,          // 遨ｺ逋ｽ逕ｻ蜒・
        /empty/i,          // 遨ｺ縺ｮ逕ｻ蜒・
        /spacer/i,         // 繧ｹ繝夲ｿｽE繧ｵ繝ｼ逕ｻ蜒・
        /transparent/i,    // 騾擾ｿｽE逕ｻ蜒・
        /clear/i,          // 繧ｯ繝ｪ繧｢逕ｻ蜒・
        /1x1/i,           // 1x1繝斐け繧ｻ繝ｫ逕ｻ蜒・
        /pixel/i,         // 繝斐け繧ｻ繝ｫ逕ｻ蜒擾ｼ医ヨ繝ｩ繝・・ｽ・ｽ繝ｳ繧ｰ逕ｨ・ｽE・ｽE
        /tracking/i,      // 繝医Λ繝・・ｽ・ｽ繝ｳ繧ｰ逕ｻ蜒・
        /analytics/i,     // 蛻・・ｽ・ｽ逕ｨ逕ｻ蜒・
        /beacon/i,        // 繝難ｿｽE繧ｳ繝ｳ逕ｻ蜒・
        /\.(gif|svg)$/i   // GIF, SVG縺ｯ隱ｿ逅・・ｽE逵溘〒縺ｯ縺ｪ縺・・ｽ・ｽ閭ｽ諤ｧ縺碁ｫ倥＞
      ];
      
      // 繝輔ぃ繧､繝ｫ蜷阪↓諤ｪ縺励＞繝代ち繝ｼ繝ｳ縺後↑縺・・ｽ・ｽ繝√ぉ繝・・ｽ・ｽ
      const suspiciousPatterns = [
        /^[a-f0-9]{8,}$/i,  // 繝上ャ繧ｷ繝･縺ｮ繧医≧縺ｪ繝輔ぃ繧､繝ｫ蜷・
        /^pixel/i,          // pixel縺ｧ蟋九∪繧・
        /^spacer/i,         // spacer縺ｧ蟋九∪繧・
        /^blank/i           // blank縺ｧ蟋九∪繧・
      ];
      
      const fileName = url.split('/').pop()?.split('?')[0] || '';
      const hasSuspiciousName = suspiciousPatterns.some(pattern => pattern.test(fileName));
      
      return !excludePatterns.some(pattern => pattern.test(url)) && !hasSuspiciousName;
    };
    
    if (typeof imageData === 'string') {
      return validateImageUrl(imageData) ? imageData : undefined;
    }
    
    if (Array.isArray(imageData)) {
      // 蜩∬ｳｪ鬆・・ｽ・ｽ蜆ｪ蜈磯・・ｽ・ｽ繧偵▽縺代※驕ｸ謚・
      const validImages = imageData
        .filter(img => typeof img === 'string' && validateImageUrl(img))
        .sort((a, b) => {
          // 鬮倩ｧ｣蜒丞ｺｦ繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ蜆ｪ蜈・
          const highQualityKeywords = ['large', 'high', 'original', 'full', '1024', '800', '600'];
          const aScore = highQualityKeywords.reduce((score, keyword) => 
            a.toLowerCase().includes(keyword) ? score + 1 : score, 0);
          const bScore = highQualityKeywords.reduce((score, keyword) => 
            b.toLowerCase().includes(keyword) ? score + 1 : score, 0);
          return bScore - aScore;
        });
      
      return validImages[0];
    }
    
    if (imageData.url && validateImageUrl(imageData.url)) {
      return imageData.url;
    }
    
    return undefined;
  }

  // 蜍慕判URL繧呈歓蜃ｺ・ｽE・ｽ蜴ｳ譬ｼ縺ｪ讀懆ｨｼ莉倥″・ｽE・ｽE
  private extractVideoUrl(videoData: any): string | undefined {
    if (!videoData) return undefined;
    
    const validateVideoUrl = (url: string): boolean => {
      if (!url || typeof url !== 'string') return false;
      
      // 蜍慕判繝励Λ繝・・ｽ・ｽ繝輔か繝ｼ繝繧・・ｽ・ｽ蠑ｵ蟄舌メ繧ｧ繝・・ｽ・ｽ
      const validVideoPatterns = [
        /youtube\.com\/watch\?v=/i,
        /youtu\.be\//i,
        /youtube\.com\/embed\//i,
        /vimeo\.com\/\d+/i,
        /dailymotion\.com/i,
        /\.(mp4|avi|mov|wmv|flv|webm|mkv|m4v)(\?.*)?$/i
      ];
      
      return validVideoPatterns.some(pattern => pattern.test(url));
    };
    
    if (typeof videoData === 'string') {
      return validateVideoUrl(videoData) ? videoData : undefined;
    }
    
    if (Array.isArray(videoData)) {
      const validVideos = videoData.filter(video => 
        typeof video === 'string' && validateVideoUrl(video)
      );
      return validVideos[0];
    }
    
    if (videoData.contentUrl && validateVideoUrl(videoData.contentUrl)) {
      return videoData.contentUrl;
    }
    
    if (videoData.url && validateVideoUrl(videoData.url)) {
      return videoData.url;
    }
    
    // YouTube蝓九ａ霎ｼ縺ｿURL縺ｮ讀懶ｿｽE縺ｨ讀懆ｨｼ
    if (videoData.embedUrl && validateVideoUrl(videoData.embedUrl)) {
      return videoData.embedUrl;
    }
    
    return undefined;
  }

  // 隍・・ｽ・ｽ逕ｻ蜒擾ｿｽE謚ｽ蜃ｺ
  private extractMultipleImages(imageData: any): string[] {
    if (!imageData) return [];
    
    if (typeof imageData === 'string') {
      return [imageData];
    }
    
    if (Array.isArray(imageData)) {
      return imageData.filter(img => typeof img === 'string');
    }
    
    return [];
  }

  // 謇矩・・ｽ・ｽ騾｣逕ｻ蜒上ｒHTML縺九ｉ謚ｽ蜃ｺ・ｽE・ｽ蜴ｳ譬ｼ縺ｪ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ・ｽE・ｽE
  private extractStepImages(html: string, keywords: string[]): string[] {
    const images: string[] = [];
    
    try {
      // img隕∫ｴ縺ｮsrc繧呈歓蜃ｺ
      const imgMatches = html.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/g);
      if (imgMatches) {
        for (const match of imgMatches) {
          const srcMatch = match.match(/src=["']([^"']+)["']/);
          if (srcMatch && srcMatch[1]) {
            const imgUrl = srcMatch[1];
            
            // 謇矩・・ｽ・ｽ騾｣逕ｻ蜒擾ｿｽE蜴ｳ譬ｼ縺ｪ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
            const isStepRelated = 
              // 謇矩・・ｽ・ｽ繝ｼ繝ｯ繝ｼ繝峨ｒ蜷ｫ繧
              imgUrl.includes('step') || 
              imgUrl.includes('cook') || 
              imgUrl.includes('recipe') ||
              imgUrl.includes('process') ||
              imgUrl.includes('making') ||
              // 謨ｰ蟄励ｒ蜷ｫ繧・ｽE・ｽ謇矩・・ｽ・ｽ蜿ｷ縺ｮ蜿ｯ閭ｽ諤ｧ・ｽE・ｽE
              /step[_-]?\d+/i.test(imgUrl) ||
              // 繧ｭ繝ｼ繝ｯ繝ｼ繝峨↓髢｢騾｣
              keywords.some(keyword => 
                keyword.length > 2 && 
                imgUrl.toLowerCase().includes(keyword.toLowerCase())
              );
            
            // 髯､螟悶ヱ繧ｿ繝ｼ繝ｳ
            const shouldExclude =
              /logo/i.test(imgUrl) ||
              /banner/i.test(imgUrl) ||
              /ad[s]?/i.test(imgUrl) ||
              /avatar/i.test(imgUrl) ||
              /profile/i.test(imgUrl) ||
              /icon/i.test(imgUrl) ||
              /button/i.test(imgUrl) ||
              /navigation/i.test(imgUrl) ||
              /header/i.test(imgUrl) ||
              /footer/i.test(imgUrl) ||
              /sidebar/i.test(imgUrl) ||
              // 蟆上＆縺・・ｽ・ｽ繧､繧ｺ縺ｮ逕ｻ蜒・
              /\d{1,2}x\d{1,2}/i.test(imgUrl) ||
              // 繧ｽ繝ｼ繧ｷ繝｣繝ｫ繝｡繝・・ｽ・ｽ繧｢髢｢騾｣
              /facebook|twitter|instagram|line/i.test(imgUrl);
            
            if (isStepRelated && !shouldExclude) {
              images.push(imgUrl);
            }
          }
        }
      }
    } catch (error) {
      console.warn('謇矩・・ｽ・ｽ蜒乗歓蜃ｺ繧ｨ繝ｩ繝ｼ:', error);
    }
    
    // 譛螟ｧ3譫壹↓蛻ｶ髯舌＠縲・・ｽ・ｽ隍・・ｽ・ｽ髯､
    return [...new Set(images)].slice(0, 3);
  }

  // 謇矩・・ｽ・ｽ譛会ｿｽE逕ｻ蜒上ｒ謚ｽ蜃ｺ・ｽE・ｽ謇矩・・ｽ・ｽ蜿ｷ縺ｨ繧ｭ繝ｼ繝ｯ繝ｼ繝峨〒蜴ｳ蟇・・ｽ・ｽ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ・ｽE・ｽE
  private extractStepSpecificImages(html: string, stepNumber: number, keywords: string[]): string[] {
    const images: string[] = [];
    
    try {
      // 繧医ｊ蜴ｳ蟇・・ｽ・ｽ謇矩・・ｽ・ｽ譛臥判蜒擾ｿｽE讀懶ｿｽE
      const imgMatches = html.match(/<img[^>]+src=["']([^"']+)["'][^>]*>/g);
      if (imgMatches) {
        for (const match of imgMatches) {
          const srcMatch = match.match(/src=["']([^"']+)["']/);
          if (srcMatch && srcMatch[1]) {
            const imgUrl = srcMatch[1];
            
            // 謇矩・・ｽ・ｽ蜿ｷ縺ｫ繧医ｋ蜴ｳ蟇・・ｽ・ｽ繝槭ャ繝√Φ繧ｰ
            const stepNumberPatterns = [
              new RegExp(`step[_-]?0*${stepNumber}[^\\d]`, 'i'),
              new RegExp(`謇矩・_-]?0*${stepNumber}[^\\d]`, 'i'),
              new RegExp(`蟾･遞擬_-]?0*${stepNumber}[^\\d]`, 'i'),
              new RegExp(`${stepNumber}[_-]?(step|謇矩・蟾･遞・`, 'i')
            ];
            
            const hasStepNumber = stepNumberPatterns.some(pattern => pattern.test(imgUrl));
            
            // 繧ｭ繝ｼ繝ｯ繝ｼ繝会ｿｽE繝ｼ繧ｹ縺ｮ繝槭ャ繝√Φ繧ｰ・ｽE・ｽ繧医ｊ蜴ｳ蟇・・ｽ・ｽE
            const hasRelevantKeyword = keywords.length > 0 && keywords.some(keyword => {
              if (keyword.length < 2) return false;
              // 螳鯉ｿｽE荳閾ｴ縺ｾ縺滂ｿｽE驛ｨ蛻・・ｽ・ｽ閾ｴ・ｽE・ｽ縺溘□縺玲э蜻ｳ縺ｮ縺ゅｋ蜊倩ｪ橸ｿｽE縺ｿ・ｽE・ｽE
              return imgUrl.toLowerCase().includes(keyword.toLowerCase()) ||
                     match.toLowerCase().includes(keyword.toLowerCase()); // img隕∫ｴ蜈ｨ菴薙ｂ繝√ぉ繝・・ｽ・ｽ
            });
            
            // 蝓ｺ譛ｬ逧・・ｽ・ｽ謇矩・・ｽ・ｽ騾｣繧ｭ繝ｼ繝ｯ繝ｼ繝・
            const hasStepKeyword = 
              /step|cook|recipe|process|making|preparation/i.test(imgUrl);
            
            // 髯､螟悶ヱ繧ｿ繝ｼ繝ｳ・ｽE・ｽ繧医ｊ蜴ｳ譬ｼ・ｽE・ｽE
            const shouldExclude =
              /logo|banner|ad[s]?|avatar|profile|icon|button/i.test(imgUrl) ||
              /navigation|header|footer|sidebar|menu/i.test(imgUrl) ||
              /facebook|twitter|instagram|line|social/i.test(imgUrl) ||
              /\d{1,2}x\d{1,2}/i.test(imgUrl) ||
              /thumbnail|thumb/i.test(imgUrl) ||
              // 蜷後§逕ｻ蜒酋RL縺瑚､・・ｽ・ｽ縺ｮ謇矩・・ｽ・ｽ菴ｿ繧上ｌ繧九％縺ｨ繧帝∩縺代ｋ
              imgUrl.includes('main') || imgUrl.includes('hero') ||
              imgUrl.includes('featured') || imgUrl.includes('cover');
            
            // 謇矩・・ｽ・ｽ譛峨→蛻､螳壹＆繧後ｋ譚｡莉ｶ
            const isStepSpecific = (hasStepNumber || hasRelevantKeyword || hasStepKeyword) && !shouldExclude;
            
            if (isStepSpecific) {
              images.push(imgUrl);
            }
          }
        }
      }
      
      console.log(`剥 謇矩・{stepNumber}縺ｮ逕ｻ蜒乗､懶ｿｽE:`, {
        keywords,
        foundImages: images.length,
        images: images.slice(0, 2) // 譛蛻晢ｿｽE2譫夲ｿｽE縺ｿ繝ｭ繧ｰ縺ｫ蜃ｺ蜉・
      });
      
    } catch (error) {
      console.warn('謇矩・・ｽ・ｽ譛臥判蜒乗歓蜃ｺ繧ｨ繝ｩ繝ｼ:', error);
    }
    
    // 謇矩・・ｽ・ｽ譛臥判蜒擾ｿｽE譛螟ｧ2譫壹↓蛻ｶ髯・
    return [...new Set(images)].slice(0, 2);
  }

  // Microdata謚ｽ蜃ｺ・ｽE・ｽ繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ・ｽE・ｽE
  private extractMicrodata(html: string): SchemaOrgRecipe | null {
    try {
      // 蝓ｺ譛ｬ逧・・ｽ・ｽMicrodata謚ｽ蜃ｺ繝ｭ繧ｸ繝・・ｽ・ｽ
      // 螳溯｣・・ｽE蠢・・ｽ・ｽ縺ｫ蠢懊§縺ｦ隧ｳ邏ｰ蛹・
      const nameMatch = html.match(/itemprop=["']name["'][^>]*>([^<]+)/i);
      const descMatch = html.match(/itemprop=["']description["'][^>]*>([^<]+)/i);
      
      if (nameMatch) {
        return {
          name: nameMatch[1],
          description: descMatch?.[1] || '',
          recipeIngredient: [],
          recipeInstructions: []
        };
      }
    } catch (error) {
      console.warn('笶・Microdata謚ｽ蜃ｺ繧ｨ繝ｩ繝ｼ:', error);
    }
    
    return null;
  }

  // 讌ｽ螟ｩ繝ｬ繧ｷ繝・+ schema.org縺ｮ邨ｱ蜷茨ｿｽE逅・
  async getProcessedRecipes(categoryId: string = '30', maxRecipes: number = 5): Promise<ProcessedJapaneseRecipe[]> {
    const basicRecipes = await this.getRecipesByCategory(categoryId);
    return this.processRecipeList(basicRecipes, maxRecipes);
  }

  // 繝ｬ繧ｷ繝斐Μ繧ｹ繝医ｒ蜃ｦ逅・・ｽ・ｽ・ｽE騾壼喧・ｽE・ｽE
  private async processRecipeList(basicRecipes: RakutenRecipeBasic[], maxRecipes: number = 5): Promise<ProcessedJapaneseRecipe[]> {
    const processedRecipes: ProcessedJapaneseRecipe[] = [];
    const globalUsedImages = new Set<string>(); // 繧ｰ繝ｭ繝ｼ繝舌Ν縺ｪ逕ｻ蜒城㍾隍・・ｽ・ｽ繧ｧ繝・・ｽ・ｽ

    console.log(`些 ${basicRecipes.length}莉ｶ縺ｮ繝ｬ繧ｷ繝斐°繧鋭chema.org謚ｽ蜃ｺ髢句ｧ義);

    for (const basic of basicRecipes.slice(0, maxRecipes)) {
      try {
        const schema = await this.extractSchemaFromRecipeUrl(basic.recipeUrl);
        
        // 謇矩・・ｽ・ｽ蜒擾ｿｽE驥崎､・・ｽ・ｽ蜴ｻ縺ｨ繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
        const filteredInstructions = this.parseInstructions(schema?.recipeInstructions || [])
          .map(instruction => {
            // 譌｢縺ｫ菴ｿ逕ｨ縺輔ｌ縺溽判蜒擾ｿｽE髯､螟・
            const filteredImage = instruction.image && !globalUsedImages.has(instruction.image) 
              ? instruction.image 
              : undefined;
              
            const filteredImages = (instruction.images || [])
              .filter(img => !globalUsedImages.has(img))
              .slice(0, 2); // 譛螟ｧ2譫・

            // 菴ｿ逕ｨ縺輔ｌ縺溽判蜒上ｒ險倬鹸
            if (filteredImage) globalUsedImages.add(filteredImage);
            filteredImages.forEach(img => globalUsedImages.add(img));

            return {
              ...instruction,
              image: filteredImage,
              images: filteredImages
            };
          });

        const processed: ProcessedJapaneseRecipe = {
          id: basic.recipeId || `recipe-${Date.now()}`,
          title: schema?.name || basic.recipeTitle || '繝ｬ繧ｷ繝・,
          description: schema?.description || basic.recipeDescription || '',
          imageUrl: basic.foodImageUrl || '',
          sourceUrl: basic.recipeUrl || '',
          ingredients: this.parseIngredients(schema?.recipeIngredient || basic.recipeMaterial || []),
          instructions: filteredInstructions,
          cookingTime: schema?.totalTime || basic.recipeIndication || '30蛻・,
          cost: basic.recipeCost || '300蜀・,
          nutrition: schema?.nutrition,
          source: 'rakuten',
          createdAt: Date.now()
        };

        processedRecipes.push(processed);
        console.log(`笨・繝ｬ繧ｷ繝費ｿｽE逅・・ｽ・ｽ莠・ ${processed.title} (逕ｻ蜒・ ${filteredInstructions.filter(i => i.image).length}譫・`);
        
      } catch (error) {
        console.warn(`笶・繝ｬ繧ｷ繝費ｿｽE逅・・ｽ・ｽ繝ｩ繝ｼ (${basic.recipeTitle}):`, error);
      }
    }

    console.log(`脂 ${processedRecipes.length}莉ｶ縺ｮ繝ｬ繧ｷ繝費ｿｽE逅・・ｽ・ｽ莠・);
    return processedRecipes;
  }

  // 譚先侭縺ｮ隗｣譫・
  private parseIngredients(ingredients: string[]): { name: string; amount: string }[] {
    if (!Array.isArray(ingredients)) return [];
    
    return ingredients.map(ingredient => {
      if (!ingredient || typeof ingredient !== 'string') {
        return { name: '譚先侭', amount: '驕ｩ驥・ };
      }
      
      // "譚先侭蜷・蛻・・ｽ・ｽ" 縺ｮ蠖｢蠑上ｒ隗｣譫・
      const match = ingredient.match(/^(.+?)\s*[・ｽE・ｽE]\s*(.+)$/) || 
                   ingredient.match(/^(.+?)\s+(.+)$/) ||
                   [null, ingredient, '驕ｩ驥・];
      
      return {
        name: match[1]?.trim() || ingredient || '譚先侭',
        amount: match[2]?.trim() || '驕ｩ驥・
      };
    });
  }

  // 隱ｿ逅・・ｽ・ｽ鬆・・ｽE隗｣譫・
  private parseInstructions(instructions: RecipeInstruction[]): { stepNumber: number; text: string; image?: string; video?: string; images?: string[] }[] {
    if (!Array.isArray(instructions)) return [];
    
    return instructions.map((instruction, index) => ({
      stepNumber: index + 1,
      text: instruction?.text || `謇矩・{index + 1}`,
      image: instruction?.image,
      video: instruction?.video,
      images: instruction?.images
    }));
  }

  // 繧ｭ繝｣繝・・ｽ・ｽ繝･繧ｯ繝ｪ繧｢
  clearCache(): void {
    this.cache.clear();
    console.log('ｧｹ 繧ｭ繝｣繝・・ｽ・ｽ繝･繧偵け繝ｪ繧｢縺励∪縺励◆');
  }

  // 螳滄圀縺ｮAPI繧剃ｽｿ縺｣縺溽悄縺ｮ繧ｭ繝ｼ繝ｯ繝ｼ繝画､懃ｴ｢
  async searchRecipes(keyword: string, maxResults: number = 10): Promise<ProcessedJapaneseRecipe[]> {
    try {
      console.log(`・ｽE・ｽ API讀懃ｴ｢髢句ｧ・ "${keyword}"`);
      
      const cacheKey = `search_${keyword}_${maxResults}`;
      const cached = this.cache.get(cacheKey);
      
      if (cached) {
        console.log(`沈 繧ｭ繝｣繝・・ｽ・ｽ繝･繝偵ャ繝・ "${keyword}" - ${cached.length}莉ｶ`);
        return cached;
      }

      await this.rateLimiter.waitIfNeeded();

      // 隍・・ｽ・ｽ縺ｮ謌ｦ逡･縺ｧ繝ｬ繧ｷ繝斐ｒ讀懃ｴ｢
      const allRecipes: ProcessedJapaneseRecipe[] = [];
      
      // 謌ｦ逡･1: 繧ｭ繝ｼ繝ｯ繝ｼ繝峨〒逶ｴ謗･讀懃ｴ｢
      console.log(`剥 讌ｽ螟ｩAPI縺ｧ逶ｴ謗･繧ｭ繝ｼ繝ｯ繝ｼ繝画､懃ｴ｢: "${keyword}"`);
      const directSearchRecipes = await this.searchRecipesByKeyword(keyword);
      
      if (directSearchRecipes.length > 0) {
        console.log(`笨・逶ｴ謗･讀懃ｴ｢縺ｧ ${directSearchRecipes.length}莉ｶ隕九▽縺九ｊ縺ｾ縺励◆`);
        // 逶ｴ謗･讀懃ｴ｢縺ｮ邨先棡繧抵ｿｽE逅・
        const processedDirectRecipes = await this.processRecipeList(directSearchRecipes, maxResults);
        
        if (processedDirectRecipes.length > 0) {
          this.cache.set(cacheKey, processedDirectRecipes);
          console.log(`笨・"${keyword}" 縺ｧ ${processedDirectRecipes.length}莉ｶ縺ｮ繝ｬ繧ｷ繝斐ｒ逋ｺ隕義);
          processedDirectRecipes.slice(0, 3).forEach((recipe, index) => {
            console.log(`   ${index + 1}. "${recipe.title}"`);
          });
          return processedDirectRecipes;
        }
      }
      
      // 謌ｦ逡･2: 繧ｫ繝・・ｽ・ｽ繝ｪ繝呻ｿｽE繧ｹ讀懃ｴ｢・ｽE・ｽ逶ｴ謗･讀懃ｴ｢縺ｧ隕九▽縺九ｉ縺ｪ縺・・ｽ・ｽ蜷茨ｼ・
      console.log(`庁 繧ｫ繝・・ｽ・ｽ繝ｪ繝呻ｿｽE繧ｹ讀懃ｴ｢縺ｫ繝輔か繝ｼ繝ｫ繝舌ャ繧ｯ`);
      const relevantCategories = this.getRelevantCategoriesForKeyword(keyword);
      console.log(`識 "${keyword}" 縺ｮ讀懃ｴ｢繧ｫ繝・・ｽ・ｽ繝ｪ: [${relevantCategories.join(', ')}]`);
      
      // 謌ｦ逡･3: 繧ｫ繝・・ｽ・ｽ繝ｪ縺九ｉ繝ｬ繧ｷ繝斐ｒ蜿門ｾ・
      const searchCategories = relevantCategories.length > 0 ? relevantCategories : ['10', '11', '14', '15', '16'];
      
      console.log(`藤 ${searchCategories.length}繧ｫ繝・・ｽ・ｽ繝ｪ縺九ｉ讀懃ｴ｢荳ｭ...`);
      
      for (const categoryId of searchCategories) {
        try {
          console.log(`唐 繧ｫ繝・・ｽ・ｽ繝ｪ ${categoryId} 繧呈､懃ｴ｢荳ｭ...`);
          const categoryRecipes = await this.getProcessedRecipes(categoryId, 30); // 縺輔ｉ縺ｫ螟壹￥蜿門ｾ・
          allRecipes.push(...categoryRecipes);
          
          console.log(`   笨・${categoryRecipes.length}莉ｶ蜿門ｾ・(邏ｯ險・ ${allRecipes.length}莉ｶ)`);
          
          // 1縺､縺ｮ繧ｫ繝・・ｽ・ｽ繝ｪ縺縺第､懃ｴ｢縺吶ｋ蝣ｴ蜷茨ｿｽE蠕・・ｽ・ｽ荳崎ｦ・
          if (searchCategories.length > 1 && searchCategories.indexOf(categoryId) < searchCategories.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        } catch (error) {
          console.warn(`笞・ｽE・ｽE繧ｫ繝・・ｽ・ｽ繝ｪ ${categoryId} 蜿門ｾ怜､ｱ謨・`, error);
        }
      }
      
      console.log(`逃 邱丞叙蠕玲焚: ${allRecipes.length}莉ｶ`);
      
      // 謌ｦ逡･3: 蠑ｷ蛹悶＆繧後◆繧ｭ繝ｼ繝ｯ繝ｼ繝峨ヵ繧｣繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
      const filteredRecipes = this.filterRecipesByKeyword(allRecipes, keyword);
      
      console.log(`剥 繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ邨先棡: ${allRecipes.length}莉ｶ 竊・${filteredRecipes.length}莉ｶ`);
      
      // 繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ邨先棡繧貞━蜈医√↑縺代ｌ縺ｰ蜈ｨ縺ｦ霑斐☆
      const results = filteredRecipes.length > 0 
        ? filteredRecipes.slice(0, maxResults)
        : allRecipes.slice(0, Math.min(maxResults, allRecipes.length));
      
      if (results.length > 0) {
        this.cache.set(cacheKey, results);
        const resultType = filteredRecipes.length > 0 ? '繧ｭ繝ｼ繝ｯ繝ｼ繝会ｿｽE繝・・ｽ・ｽ' : '繧ｫ繝・・ｽ・ｽ繝ｪ讀懃ｴ｢';
        console.log(`笨・"${keyword}" 縺ｧ ${results.length}莉ｶ縺ｮ繝ｬ繧ｷ繝斐ｒ逋ｺ隕・(${resultType})`);
        
        // 繝・・ｽ・ｽ繝・・ｽ・ｽ: 荳贋ｽ咲ｵ先棡繧定｡ｨ遉ｺ
        results.slice(0, 3).forEach((recipe, index) => {
          console.log(`   ${index + 1}. "${recipe.title}"`);
        });
        
        return results;
      } else {
        console.log(`笞・ｽE・ｽE"${keyword}" 縺ｫ繝槭ャ繝√☆繧九Ξ繧ｷ繝斐′隕九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆`);
        return [];
      }
      
    } catch (error) {
      console.warn(`笶・讀懃ｴ｢繧ｨ繝ｩ繝ｼ: "${keyword}"`, error);
      return [];
    }
  }



  // 蠑ｷ蛹悶＆繧後◆繧ｭ繝ｼ繝ｯ繝ｼ繝峨ヵ繧｣繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
  private filterRecipesByKeyword(recipes: ProcessedJapaneseRecipe[], keyword: string): ProcessedJapaneseRecipe[] {
    const keywordVariations = this.generateKeywordVariations(keyword);
    console.log(`剥 讀懃ｴ｢繝舌Μ繧ｨ繝ｼ繧ｷ繝ｧ繝ｳ: [${keywordVariations.join(', ')}]`);
    
    // 繝・・ｽ・ｽ繝・・ｽ・ｽ: 譛蛻晢ｿｽE3莉ｶ縺ｮ繝ｬ繧ｷ繝疲ュ蝣ｱ繧定｡ｨ遉ｺ
    console.log(`搭 蜿門ｾ励＠縺溘Ξ繧ｷ繝費ｿｽE繧ｵ繝ｳ繝励Ν:`);
    recipes.slice(0, 3).forEach((recipe, idx) => {
      console.log(`  ${idx + 1}. 繧ｿ繧､繝医Ν: "${recipe.title}"`);
      const ingredients = Array.isArray(recipe.ingredients) 
        ? recipe.ingredients.slice(0, 3).map(i => i?.name || '荳搾ｿｽE').join(', ')
        : '譚先侭縺ｪ縺・;
      console.log(`     譚先侭: ${ingredients}...`);
      console.log(`     隱ｬ譏・ ${recipe.description?.substring(0, 30) || '縺ｪ縺・}...`);
    });
    
    const scoredRecipes = recipes
      .map(recipe => ({
        recipe,
        score: this.calculateDetailedRelevanceScore(recipe, keyword, keywordVariations)
      }));
    
    console.log(`投 繧ｹ繧ｳ繧｢繝ｪ繝ｳ繧ｰ螳御ｺ・ ${scoredRecipes.filter(item => item.score > 0).length}/${scoredRecipes.length}莉ｶ縺鯉ｿｽE繝・・ｽ・ｽ`);
    
    return scoredRecipes
      .filter(item => {
        const hasMatch = item.score > 0;
        if (hasMatch) {
          console.log(`笨・繝槭ャ繝・ "${item.recipe.title}" (繧ｹ繧ｳ繧｢: ${item.score})`);
        }
        return hasMatch;
      })
      .sort((a, b) => b.score - a.score)
      .map(item => item.recipe);
  }

  // 隧ｳ邏ｰ縺ｪ髢｢騾｣蠎ｦ繧ｹ繧ｳ繧｢險育ｮ・
  private calculateDetailedRelevanceScore(recipe: ProcessedJapaneseRecipe, keyword: string, variations: string[]): number {
    let score = 0;
    const keywordLower = keyword.toLowerCase();
    let matchDetails: string[] = [];
    
    // 蝓ｺ譛ｬ逧・・ｽ・ｽ繝・・ｽE繧ｿ讀懆ｨｼ
    if (!recipe || !recipe.title) {
      console.warn(`笞・ｽE・ｽE荳肴ｭ｣縺ｪ繝ｬ繧ｷ繝斐ョ繝ｼ繧ｿ:`, recipe);
      return 0;
    }
    
    // 繧ｿ繧､繝医Ν縺ｧ縺ｮ讀懃ｴ｢(譛驥崎ｦ・
    const titleLower = (recipe.title || '').toLowerCase();
    variations.forEach(variation => {
      const varLower = variation.toLowerCase();
      
      if (titleLower.includes(varLower)) {
        if (titleLower === varLower) {
          score += 1000; // 螳鯉ｿｽE荳閾ｴ
          matchDetails.push(`繧ｿ繧､繝医Ν螳鯉ｿｽE荳閾ｴ:${variation}`);
        } else if (titleLower.startsWith(varLower) || titleLower.endsWith(varLower)) {
          score += 500; // 髢句ｧ具ｿｽE邨ゆｺ・・ｽ・ｽ閾ｴ
          matchDetails.push(`繧ｿ繧､繝医Ν髢句ｧ・邨ゆｺ・${variation}`);
        } else {
          score += 200; // 驛ｨ蛻・・ｽ・ｽ閾ｴ
          matchDetails.push(`繧ｿ繧､繝医Ν驛ｨ蛻・${variation}`);
        }
      }
    });
    
    // 譚先侭縺ｧ縺ｮ讀懃ｴ｢(驥崎ｦ・
    const ingredients = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
    ingredients.forEach(ingredient => {
      if (!ingredient || !ingredient.name) return;
      
      const ingLower = ingredient.name.toLowerCase();
      
      variations.forEach(variation => {
        const varLower = variation.toLowerCase();
        
        if (ingLower.includes(varLower)) {
          if (ingLower === varLower) {
            score += 400; // 譚先侭螳鯉ｿｽE荳閾ｴ
            matchDetails.push(`譚先侭螳鯉ｿｽE荳閾ｴ:${ingredient.name}`);
          } else {
            score += 150; // 譚先侭驛ｨ蛻・・ｽ・ｽ閾ｴ
            matchDetails.push(`譚先侭驛ｨ蛻・${ingredient.name}`);
          }
        }
      });
    });
    
    // 隱ｬ譏弱〒縺ｮ讀懃ｴ｢(陬懷勧逧・
    const description = (recipe.description || '').toLowerCase();
    variations.forEach(variation => {
      const varLower = variation.toLowerCase();
      if (description.includes(varLower)) {
        score += 50;
        matchDetails.push(`隱ｬ譏・${variation}`);
      }
    });
    
    // 繧ｹ繧ｳ繧｢縺後≠繧句ｴ蜷茨ｿｽE縺ｿ繝ｭ繧ｰ蜃ｺ蜉・
    if (score > 0) {
      console.log(`   識 "${recipe.title}" 繧ｹ繧ｳ繧｢:${score} [${matchDetails.join(', ')}]`);
    }
    
    return score;
  }

  // 繧ｭ繝ｼ繝ｯ繝ｼ繝峨↓髢｢騾｣縺吶ｋ讌ｽ螟ｩ繝ｬ繧ｷ繝斐き繝・・ｽ・ｽ繝ｪ繧貞叙蠕・諡｡蠑ｵ迚・
  // 讌ｽ螟ｩ繝ｬ繧ｷ繝尿PI縺ｮ螳滄圀縺ｮ繧ｫ繝・・ｽ・ｽ繝ｪID讒矩縺ｫ蝓ｺ縺･縺・
  private getRelevantCategoriesForKeyword(keyword: string): string[] {
    const keywordLower = keyword.toLowerCase();
    
    // 驥手除繝ｻ繧ｵ繝ｩ繝髢｢騾｣
    if (/縺阪ｅ縺・・ｽ・ｽ|繧ｭ繝･繧ｦ繝ｪ|閭｡逑忿繝茨ｿｽE繝・繝ｬ繧ｿ繧ｹ|繧ｭ繝｣繝吶ヤ|驥手除|繧ｵ繝ｩ繝/.test(keywordLower)) {
      console.log(`･・驥手除繝ｻ繧ｵ繝ｩ繝繧ｫ繝・・ｽ・ｽ繝ｪ縺九ｉ讀懃ｴ｢: [15=繧ｵ繝ｩ繝, 42=繝翫Β繝ｫ繝ｻ蜑ｯ闖・ 18=繧ｵ繝ｩ繝2, 19=髻灘嵜譁咏炊]`);
      return ['15', '42', '18', '19']; // 繧ｫ繝・・ｽ・ｽ繝ｪ謗｢邏｢縺ｧ逋ｺ隕九＆繧後◆螳滄圀縺ｮ繧ｫ繝・・ｽ・ｽ繝ｪ
    }
    
    // 閧画侭逅・・ｽ・ｽ騾｣
    if (/鮓楯繝√く繝ｳ|雎嘶繝晢ｿｽE繧ｯ|迚斈繝難ｿｽE繝怖閧・.test(keywordLower)) {
      console.log(`獄 閧画侭逅・・ｽ・ｽ繝・・ｽ・ｽ繝ｪ縺九ｉ讀懃ｴ｢: [10=莠ｺ豌・ 11=荳ｻ闖・ 17=荳ｻ闖・]`);
      return ['10', '11', '17']; // 莠ｺ豌励∽ｸｻ闖・
    }
    
    // 縺秘｣ｯ繝ｻ鮗ｺ鬘・
    if (/縺秘｣ｯ|繝√Ε繝ｼ繝上Φ|繝代せ繧ｿ|縺・・ｽ・ｽ繧倒縺晢ｿｽE|繝ｩ繝ｼ繝｡繝ｳ/.test(keywordLower)) {
      console.log(`・ｽE・ｽ 縺秘｣ｯ繝ｻ鮗ｺ鬘槭き繝・・ｽ・ｽ繝ｪ縺九ｉ讀懃ｴ｢: [10=莠ｺ豌・ 16=縺秘｣ｯ繧ゑｿｽE]`);
      return ['10', '16']; // 莠ｺ豌励√＃鬟ｯ繧ゑｿｽE
    }
    
    // 繝・・ｽ・ｽ繧ｩ繝ｫ繝・ 蟷・・ｽ・ｽE・ｽ・ｽ讀懃ｴ｢
    console.log(`識 繝・・ｽ・ｽ繧ｩ繝ｫ繝医き繝・・ｽ・ｽ繝ｪ縺九ｉ讀懃ｴ｢: [10, 11, 14]`);
    return ['10', '11', '14']; // 莠ｺ豌励∽ｸｻ闖懊∝憶闖・
  }

  // 繧ｭ繝ｼ繝ｯ繝ｼ繝会ｿｽE繝舌Μ繧ｨ繝ｼ繧ｷ繝ｧ繝ｳ繧堤函謌・
  private generateKeywordVariations(keyword: string): string[] {
    const variations: string[] = [keyword];
    
    // 縺ｲ繧峨′縺ｪ繝ｻ繧ｫ繧ｿ繧ｫ繝奇ｿｽE貍｢蟄暦ｿｽE螟画鋤繝槭ャ繝斐Φ繧ｰ (鬟滓攝繝ｻ譁咏炊蜷阪ｒ螟ｧ蟷・・ｽ・ｽ霑ｽ蜉)
    const conversionMap: { [key: string]: string[] } = {
      // 譁咏炊蜷・
      '閧峨§繧・・ｽ・ｽ': ['縺ｫ縺上§繧・・ｽ・ｽ', '繝九け繧ｸ繝｣繧ｬ', '閧峨ず繝｣繧ｬ'],
      '縺九ｉ謠壹￡': ['縺九ｉ縺ゅ￡', '繧ｫ繝ｩ繧｢繧ｲ', '蜚先恕縺・, '遨ｺ謠壹￡', '繝輔Λ繧､繝峨メ繧ｭ繝ｳ'],
      '蜊ｵ辟ｼ縺・: ['縺溘∪縺斐ｄ縺・, '繧ｿ繝槭ざ繝､繧ｭ', '邇牙ｭ千┥縺・, '縺縺怜ｷｻ縺・],
      '繝上Φ繝撰ｿｽE繧ｰ': ['縺ｯ繧難ｿｽE繝ｼ縺・, '繝滂ｿｽE繝茨ｿｽE繝ｼ繝ｫ'],
      '繧ｫ繝ｬ繝ｼ': ['縺九ｌ繝ｼ', 'curry', '繝ｫ繝ｼ'],
      '繧ｵ繝ｩ繝': ['縺輔ｉ縺', 'salad', '驥手除繧ｵ繝ｩ繝'],
      '繝代せ繧ｿ': ['縺ｱ縺吶◆', '繧ｹ繝代ご繝・・ｽ・ｽ繧｣', '繧ｹ繝代ご繝・・ｽ・ｽ'],
      
      // 驥手除
      '驥手除': ['繧・・ｽ・ｽ縺・, '繝吶ず繧ｿ繝悶Ν', '驥手除轤偵ａ'],
      '縺阪ｅ縺・・ｽ・ｽ': ['繧ｭ繝･繧ｦ繝ｪ', '閭｡逑・],
      '繝茨ｿｽE繝・: ['縺ｨ縺ｾ縺ｨ'],
      '繝ｬ繧ｿ繧ｹ': ['繧後◆縺・],
      '繧ｭ繝｣繝吶ヤ': ['縺阪ｃ縺ｹ縺､'],
      '縺ｫ繧薙§繧・: ['繝九Φ繧ｸ繝ｳ', '莠ｺ蜿・],
      '縺溘∪縺ｭ縺・: ['繧ｿ繝槭ロ繧ｮ', '邇会ｿｽE縺・, '邇芽続'],
      '繝費ｿｽE繝槭Φ': ['縺ｴ繝ｼ縺ｾ繧・],
      '縺ｪ縺・: ['繝翫せ', '闌・・ｽ・ｽE],
      '縺倥ｃ縺後＞繧・: ['繧ｸ繝｣繧ｬ繧､繝｢', '鬥ｬ驤ｴ阮ｯ'],
      '縺輔▽縺ｾ縺・・ｽ・ｽ': ['繧ｵ繝・・ｽE繧､繝｢', '阮ｩ鞫ｩ闃・],
      '縺縺・・ｽ・ｽ繧・: ['繝繧､繧ｳ繝ｳ', '螟ｧ譬ｹ'],
      '縺ｻ縺・・ｽ・ｽ繧薙◎縺・: ['繝帙え繝ｬ繝ｳ繧ｽ繧ｦ', '豕戊動闕・],
      '繧ゅｄ縺・: ['繝｢繝､繧ｷ'],
      '繝悶Ο繝・・ｽ・ｽ繝ｪ繝ｼ': ['縺ｶ繧阪▲縺薙ｊ繝ｼ'],
      
      // 閧蛾｡・
      '鮓剰ｉ': ['縺ｨ繧翫↓縺・, '繝√く繝ｳ', '鮓・, '魑･閧・],
      '雎夊ｉ': ['縺ｶ縺溘↓縺・, '繝晢ｿｽE繧ｯ', '雎・],
      '迚幄ｉ': ['縺弱ｅ縺・・ｽ・ｽ縺・, '繝難ｿｽE繝・, '迚・],
      '縺ｲ縺崎ｉ': ['繝偵く繝九け', '謖ｽ閧・, '繝溘Φ繝・],
      
      // 鬲壻ｻ矩｡・
      '縺輔￠': ['繧ｵ繧ｱ', '魄ｭ'],
      '縺ｾ縺舌ｍ': ['繝槭げ繝ｭ', '魄ｪ'],
      '縺包ｿｽE': ['繧ｵ繝・, '魃・],
      '縺ゅ§': ['繧｢繧ｸ', '魃ｵ'],
      '縺茨ｿｽE': ['繧ｨ繝・, '豬ｷ閠・],
      '縺・・ｽ・ｽ': ['繧､繧ｫ'],
      
      // 縺晢ｿｽE莉・
      '雎・・ｽE': ['縺ｨ縺・・ｽE', '繝医え繝・],
      '邏崎ｱ・: ['縺ｪ縺｣縺ｨ縺・, '繝翫ャ繝医え'],
      '蜊ｵ': ['縺溘∪縺・, '繧ｿ繝槭ざ', '邇牙ｭ・]
    };
    
    // 逶ｴ謗･繝槭ャ繝斐Φ繧ｰ縺後≠繧句ｴ蜷・
    if (conversionMap[keyword]) {
      variations.push(...conversionMap[keyword]);
    }
    
    return [...new Set(variations)]; // 驥崎､・・ｽ・ｽ蜴ｻ
  }

  // 髢｢騾｣蠎ｦ繧ｹ繧ｳ繧｢繧定ｨ育ｮ暦ｼ域隼蝟・・ｽ・ｽ・ｽE・ｽE
  private calculateRelevanceScore(recipe: ProcessedJapaneseRecipe, keyword: string, variations: string[]): number {
    let score = 0;
    const keywordLower = keyword.toLowerCase();
    
    // 繧ｿ繧､繝医Ν縺ｧ縺ｮ螳鯉ｿｽE荳閾ｴ・ｽE・ｽ譛鬮倥せ繧ｳ繧｢・ｽE・ｽE
    if (recipe.title.toLowerCase() === keywordLower) {
      score += 1000;
    }
    
    // 繧ｿ繧､繝医Ν縺ｧ縺ｮ髢句ｧ倶ｸ閾ｴ・ｽE・ｽ鬮倥せ繧ｳ繧｢・ｽE・ｽE
    if (recipe.title.toLowerCase().startsWith(keywordLower)) {
      score += 500;
    }
    
    // 繧ｿ繧､繝医Ν縺ｧ縺ｮ驛ｨ蛻・・ｽ・ｽ閾ｴ
    if (recipe.title.toLowerCase().includes(keywordLower)) {
      score += 200;
    }
    
    // 繝舌Μ繧ｨ繝ｼ繧ｷ繝ｧ繝ｳ縺ｧ縺ｮ繧ｿ繧､繝医Ν繝槭ャ繝・
    variations.forEach(variation => {
      const varLower = variation.toLowerCase();
      if (recipe.title.toLowerCase() === varLower) {
        score += 800;
      } else if (recipe.title.toLowerCase().startsWith(varLower)) {
        score += 300;
      } else if (recipe.title.toLowerCase().includes(varLower)) {
        score += 100;
      }
    });
    
    // 譚先侭縺ｧ縺ｮ螳鯉ｿｽE荳閾ｴ・ｽE・ｽ鬮倥せ繧ｳ繧｢・ｽE・ｽE
    recipe.ingredients.forEach(ingredient => {
      const ingLower = ingredient.name.toLowerCase();
      if (ingLower === keywordLower) {
        score += 400;
      } else if (ingLower.includes(keywordLower)) {
        score += 150;
      }
      
      variations.forEach(variation => {
        const varLower = variation.toLowerCase();
        if (ingLower === varLower) {
          score += 300;
        } else if (ingLower.includes(varLower)) {
          score += 80;
        }
      });
    });
    
    // 隱ｬ譏弱〒縺ｮ荳閾ｴ・ｽE・ｽ菴弱せ繧ｳ繧｢・ｽE・ｽE
    if (recipe.description.toLowerCase().includes(keywordLower)) {
      score += 50;
    }
    
    variations.forEach(variation => {
      if (recipe.description.toLowerCase().includes(variation.toLowerCase())) {
        score += 30;
      }
    });
    
    return score;
  }

  // 鬘樔ｼｼ繝ｬ繧ｷ繝斐ｒ讀懃ｴ｢
  private findSimilarRecipes(recipes: ProcessedJapaneseRecipe[], keyword: string, count: number): ProcessedJapaneseRecipe[] {
    const keywordLower = keyword.toLowerCase();
    const variations = this.generateKeywordVariations(keyword);
    
    // 蜈ｨ繝ｬ繧ｷ繝斐↓髢｢騾｣蠎ｦ繧ｹ繧ｳ繧｢繧剃ｻ倅ｸ・
    const scoredRecipes = recipes.map(recipe => ({
      recipe,
      score: this.calculateRelevanceScore(recipe, keyword, variations)
    }));
    
    // 繧ｹ繧ｳ繧｢鬆・・ｽ・ｽ繧ｽ繝ｼ繝医＠縺ｦ荳贋ｽ阪ｒ霑斐☆
    return scoredRecipes
      .sort((a, b) => b.score - a.score)
      .slice(0, count)
      .map(item => item.recipe);
  }

  // 譚先侭謨ｰ縺九ｉ髮｣譏灘ｺｦ繧呈耳螳・
  private getDifficultyByIngredientCount(ingredientCount: number): string {
    if (ingredientCount <= 3) return '邁｡蜊・;
    if (ingredientCount <= 7) return '譎ｮ騾・;
    return '髮｣縺励＞';
  }
}

// シングルトンインスタンス
export const rakutenRecipeApi = new RakutenRecipeApiService();

/**
 * 剥 繝・・ｽ・ｽ繝・・ｽ・ｽ逕ｨ: 繧ｫ繝・・ｽ・ｽ繝ｪ謗｢邏｢繧貞ｮ溯｡・
 * 菴ｿ縺・・ｽ・ｽ: HomeScreen遲峨〒 import { debugExploreCategories } from '../services/rakutenRecipeApi';
 *        await debugExploreCategories('縺阪ｅ縺・・ｽ・ｽ');
 */
export async function debugExploreCategories(keyword: string = '縺阪ｅ縺・・ｽ・ｽ'): Promise<void> {
  await rakutenRecipeApi.debugCategoryExploration(keyword);
}
