# 実験007 技術的課題分析レポート
## 弁当箱検出AI性能比較実験の問題点と改善提案

**作成日:** 2025年11月10日  
**対象実験:** 実験007（ゼミ実験7回目）

---

## 1. 実験データ分析

### 1.1 検出された異常データ

#### OpenCV異常検出例
```json
// cropped_bento_1762695877651.jpg - OpenCV結果
{
  "bbox": {
    "x": 232, "y": 437,
    "width": 63, "height": 62,
    "width_mm": 13.6, "height_mm": 13.4
  },
  "error_mm": 196.7
}
```
**問題点:** 13.6×13.4mmは弁当箱として非現実的なサイズ（実際は13.6×13.4cm程度が妥当→変換係数10倍エラーの可能性）

#### Hybrid異常動作例  
```json
// 同一画像でOpenCVとHybridが完全同一結果
OpenCV: "error_mm": 41.31448771822018
Hybrid:  "error_mm": 41.31448771822018
// 小数点以下まで完全一致 → 真のハイブリッド処理ではない
```

### 1.2 統計的妥当性検証

| 手法 | 最小誤差(mm) | 最大誤差(mm) | 標準偏差 | CV値* |
|------|-------------|-------------|----------|--------|
| OpenCV | 41.3 | 201.8 | 69.8 | 0.52 |
| YOLO | 24.7 | 135.4 | 45.6 | 0.65 |
| Hybrid | 41.3 | 205.5 | 67.9 | 0.52 |

*CV値 = 標準偏差/平均値（変動係数）

**分析:** OpenCVとHybridのCV値が同一（0.52）なのは統計的に不自然

---

## 2. 根本原因分析

### 2.1 OpenCV検出アルゴリズムの問題

#### 推定される問題点
1. **輪郭検出閾値の不適切設定**
   - 小さなノイズも弁当箱として誤認識
   - 最小サイズ制約の不在

2. **前処理の不十分さ**
   - ガウシアンブラーやモルフォロジー処理の最適化不足
   - エッジ検出パラメータの調整必要

#### 修正提案コード例
```python
# 最小サイズ制約の追加
MIN_BENTO_SIZE = (100, 80)  # 最小100×80ピクセル
MAX_BENTO_SIZE = (500, 400)  # 最大500×400ピクセル

def filter_contours(contours):
    filtered = []
    for contour in contours:
        x, y, w, h = cv2.boundingRect(contour)
        if (MIN_BENTO_SIZE[0] <= w <= MAX_BENTO_SIZE[0] and 
            MIN_BENTO_SIZE[1] <= h <= MAX_BENTO_SIZE[1]):
            filtered.append(contour)
    return filtered
```

### 2.2 Hybridモード実装の問題

#### 現在の推定動作
```python
# 疑われる現在の実装
def hybrid_detection(image):
    opencv_result = opencv_detect(image)
    yolo_result = yolo_detect(image) 
    
    # 問題: 単純にOpenCV結果を返している？
    return opencv_result  # ← これが原因で同一結果
```

#### 理想的なHybrid実装案
```python
def hybrid_detection(image):
    opencv_result = opencv_detect(image)
    yolo_result = yolo_detect(image)
    
    # 信頼度による重み付け平均
    if opencv_result['confidence'] > yolo_result['confidence']:
        weight_cv, weight_yolo = 0.7, 0.3
    else:
        weight_cv, weight_yolo = 0.3, 0.7
    
    # バウンディングボックスの重み付け平均
    hybrid_bbox = {
        'x': int(opencv_result['x'] * weight_cv + yolo_result['x'] * weight_yolo),
        'y': int(opencv_result['y'] * weight_cv + yolo_result['y'] * weight_yolo),
        'width': int(opencv_result['width'] * weight_cv + yolo_result['width'] * weight_yolo),
        'height': int(opencv_result['height'] * weight_cv + yolo_result['height'] * weight_yolo)
    }
    
    return hybrid_bbox
```

---

## 3. 実験設計の課題

### 3.1 Ground Truth問題
- **問題:** Ground Truthの設定方法が不明確
- **影響:** 誤差計算の信頼性低下
- **改善案:** 手動アノテーションツールによる精密な真値設定

### 3.2 ピクセル→mm変換係数
- **問題:** 変換係数の精度が検証されていない
- **改善案:** 既知サイズの校正オブジェクトを用いた係数再計算

### 3.3 テストデータの偏り
- **問題:** 6枚のみのデータでは統計的有意性に疑問
- **改善案:** 最低30枚以上のバランス取れたデータセット構築

---

## 4. 優先度付き改善プラン

### 🔴 緊急度：HIGH（1週間以内）

1. **OpenCV検出ロジック修正**
   ```python
   # 実装すべき制約
   - 最小サイズフィルタ追加
   - アスペクト比制約（弁当箱らしい比率）
   - 信頼度スコア動的計算
   ```

2. **Hybridアルゴリズム再実装**
   ```python
   # 実装すべき統合ロジック
   - 信頼度ベース重み付け
   - バウンディングボックス統合
   - 複数候補からの最適解選択
   ```

### 🟡 緊急度：MEDIUM（2週間以内）

3. **Ground Truth精度向上**
   - 手動アノテーションツール導入
   - 複数人によるクロスチェック
   - 校正用基準オブジェクト設置

4. **実験データ拡充**
   - 照明条件変更（自然光、LED、蛍光灯）
   - 角度変更（0°、15°、30°、45°、60°）
   - 距離変更（20cm、30cm、40cm、50cm）

### 🟢 緊急度：LOW（1ヶ月以内）

5. **新手法導入検討**
   - YOLOv8/YOLOv11の性能評価
   - Transformer-based手法（DETR等）の調査
   - セグメンテーションモデルの適用検討

---

### 期待される改善効果（修正後予想）

#### 定量的改善目標
| 項目 | 修正前 | 修正後予想 | 改善率 | 評価 |
|------|--------|------------|--------|------|
| OpenCV精度 | 134mm | **13.4mm** | 90%改善 | 実用的 |
| YOLO精度 | 70mm | **7.0mm** | 90%改善 | 超高精度 |
| Hybrid精度 | 131mm | **13.1mm** | 90%改善 | 優秀 |
| 弁当箱サイズ | 13.6mm | **136mm** | 現実的 | 正常 |
| 実用性 | ❌ | ✅ | 劇的改善 | 完全改善 |

#### 定性的改善効果
- **信頼性向上**: 現実的な測定値による実験結果の妥当性確保
- **実用性確保**: 全手法が実際のアプリケーションに適用可能
- **研究価値向上**: 学術的に意味のある高精度実験の実現
- **技術選択**: 用途別最適手法の明確な選択指針

---

## 6. リスク分析と対策

### 主要リスク
1. **OpenCV修正による性能劣化**
   - 対策: A/Bテストによる段階的改善
   
2. **Hybrid実装の複雑化**
   - 対策: シンプルな統合ロジックから開始
   
3. **データ収集の時間コスト**
   - 対策: 自動撮影システムの構築検討

### 成功指標
- [ ] OpenCV異常検出の解消（100%）
- [ ] Hybrid独自性の確保（OpenCVと異なる結果>80%）
- [ ] 統計的有意性の確保（n≥30）
- [ ] 実用レベル精度の達成（誤差<30mm）

---

## 7. 次週の具体的アクション

### 月曜日
- OpenCV検出コードの詳細レビュー
- 最小サイズ制約の実装とテスト

### 火曜日  
- Hybridモード実装の完全見直し
- 重み付け統合ロジックの設計

### 水曜日
- Ground Truth再設定作業
- 校正オブジェクトを用いた係数再計算

### 木曜日
- 新実装での予備実験実施
- 初期結果の妥当性確認

### 金曜日
- 改善版実験の本実施
- 結果分析と次週計画立案

---

## まとめ

現在の実験007は**概念実証としては有意義**だが、**技術的課題が多数存在**する。特にOpenCVの異常検出とHybridモードの実装不備は早急な修正が必要。

しかし、これらの課題を克服することで、**実用的な弁当箱検出システム**の構築が十分可能であり、研究としての価値も大幅に向上すると期待される。

**次回実験（実験008）では、これらの改善を反映した真の性能比較**を実施し、より信頼性の高い結果を得ることを目標とする。